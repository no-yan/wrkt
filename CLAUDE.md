# Claude Implementation Context

This document contains **Claude-specific instructions** for implementing and maintaining the `wrkt` project.

## üö® CRITICAL DEVELOPMENT RULES

### MANDATORY: TodoWrite/TodoRead Usage
**Before starting ANY development work, Claude MUST:**
1. **Read Current Todo List**: Use `TodoRead` tool to check existing tasks
2. **Plan Work**: Use `TodoWrite` tool to create/update task list for the session
3. **Track Progress**: Update todo status throughout development:
   - `"pending"` - Task not yet started
   - `"in_progress"` - Currently working on (limit to ONE at a time)
   - `"completed"` - Task finished successfully
4. **Mark Completion**: IMMEDIATELY mark tasks as completed when finished

### MANDATORY: Dogfooding Principles
**Absolute Rules to Follow:**
- **Always use wrkt commands for worktree operations**
- **Prohibit direct branch operations in main directory**
- **Prohibit branch switching within existing worktrees**

**Correct Operation Procedure:**
1. `./wrkt add <branch>` to create worktree
2. `./wrkt switch <name>` to move (auto-cd after shell integration implementation, manual cd before)
3. Work only within worktrees, no branch changes
4. Always check status with `./wrkt list --verbose` at session start

**Prohibited Operations:**
```bash
# ‚ùå Prohibited: Feature branch work in main directory
git checkout -b feature/new-feature  

# ‚ùå Prohibited: Branch switching within worktrees
cd /path/to/worktree && git checkout other-branch

# ‚úÖ Correct: Create worktree with wrkt command
./wrkt add feature/new-feature
```

**Design Philosophy:**
- **1 worktree = 1 dedicated branch = 1 feature**
- **Main directory = main branch only**
- **Realize branch switching through worktree creation**

## üìä TASK MANAGEMENT

### Parallel Development Manager Responsibilities
**When acting as manager for multiple Claude agents working on different worktrees:**

1. **Conflict Prevention**: Analyze all feature branches before assigning tasks to prevent merge conflicts
2. **Priority-Based Coordination**: Pause lower priority work when conflicts are detected
3. **Sequential Integration**: Merge features one-by-one in dependency order
4. **Test Validation**: Ensure ALL tests pass before any merge attempt
5. **Rollback Strategy**: Abort merges immediately if tests fail
6. **Documentation Updates**: Record all coordination decisions and conflicts in CLAUDE.md

**Conflict Resolution Protocol:**
- Run `git diff f0c4919..branch --name-only` to analyze file changes
- Stop development on conflicting features until higher priority merges complete
- Coordinate timing of commits to avoid simultaneous changes to same files
- Always test merges in clean environment before final integration

**GitHub PR Integration Process:**
- Use GitHub Pull Requests for all feature merges instead of direct git merge
- Create PRs using `gh pr create` with proper titles and descriptions
- Ensure all tests pass in PR before merging
- Use PR reviews to validate changes before integration
- Merge PRs sequentially to prevent conflicts

### Worktree Development Workflow
**When working across multiple worktrees:**

1. **Check WORKTREE_TRACKING.md** - Review status of all active worktrees
2. **Use TodoWrite** to plan which worktrees to work on
3. **Work systematically** - Complete one worktree before moving to next
4. **Update tracking documents** when switching between worktrees
5. **Commit frequently** with descriptive messages

### Task Categories
- **High Priority**: Core functionality, bug fixes, incomplete features
- **Medium Priority**: Enhancements, new features, optimizations  
- **Low Priority**: Documentation, cleanup, nice-to-have features

### Example Todo Usage
```
TodoWrite: [
  {"content": "Complete feature-list-filters worktree", "status": "in_progress", "priority": "high", "id": "1"},
  {"content": "Add zsh tab completion", "status": "pending", "priority": "medium", "id": "2"},
  {"content": "Update documentation", "status": "pending", "priority": "low", "id": "3"}
]
```

## üèóÔ∏è CORE IMPLEMENTATION NOTES

### Worktree Organization
- All worktrees created in `$REPO_ROOT/worktrees/` subdirectory
- Auto-create worktrees/ directory on first use
- Auto-add "worktrees/" to .gitignore
- Path generation: `feature/auth` ‚Üí `worktrees/feature-auth/`

### Zsh Integration Implementation
- `wrkt switch` command should only resolve and return the target path
- Actual directory changing is handled by zsh functions
- Zsh functions must be generated by `wrkt shell-init`
- Only support zsh - show clear error for other shells

### Command Design
- `wrkt list` is the primary information command
- No separate `wrkt status` - use `wrkt list --dirty` instead
- `wrkt list --verbose` provides detailed git status
- **Exact name matching only** - no fuzzy matching complexity

## üîß DEVELOPMENT REFERENCE

### Development Commands
```bash
# Build and test
go build -o wrkt
go test ./...

# Run linting
golangci-lint run
```

### Session Management Best Practices
- **At start**: Verify worktree and branch consistency with `./wrkt list --verbose`
- **During work**: Thorough use of wrkt commands
- **When problems occur**: Priority resolution of root cause (dogfooding violations)
- **Before ending**: Record status for next session

### Troubleshooting Dogfooding Issues
- **"Branch assignments are mixed up"**: Dogfooding principle violation, enforce wrkt command usage
- **"Main directory on wrong branch"**: Caused by direct branch operations in main directory, return to main
- **Branch confusion**: Root cause is using traditional git operations, execute all operations through wrkt commands

## Notes for Future Claude Sessions

1. **Zsh-only integration** - Don't implement multi-shell support
2. **Worktrees go in `worktrees/` subdirectory** - Always use this location
3. **No fuzzy matching** - Exact name matching only
4. **Always check existing code** before implementing new features
5. **Follow the established patterns** in cmd/ and internal/ directories
6. **Test zsh integration** thoroughly
7. **Update tests** when adding new functionality
8. **Validate MVP scope** - don't add features beyond core requirements
9. **Test with real git repositories** to ensure robustness
10. **Update documentation** when changing behavior
11. **ALWAYS USE TodoWrite/TodoRead** - Essential for tracking progress across sessions
12. **Check WORKTREE_TRACKING.md** - Review worktree status before starting work
13. **Clean command uses `git worktree prune`** - This is the correct approach for stale worktrees
14. **Integration tests are comprehensive** - Cover full worktree lifecycle and edge cases

## Quick References

- **Project Overview**: See [README.md](README.md)
- **MVP Scope**: See [docs/implementation/mvp.md](docs/implementation/mvp.md)
- **Architecture**: See [docs/implementation/architecture.md](docs/implementation/architecture.md)
- **Development Guidelines**: See [docs/implementation/contributing.md](docs/implementation/contributing.md)
- **Command Reference**: See [docs/api/commands.md](docs/api/commands.md)